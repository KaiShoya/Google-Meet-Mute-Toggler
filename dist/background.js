const b="https://meet.google.com/",d="https://meet.google.com/*",h="https://teams.microsoft.com/_",T="https://teams.microsoft.com/_*",p="https://teams.microsoft.com/v2/",g="https://teams.microsoft.com/v2/*",f={[b]:{},[h]:{hash:"#/modern-calling/"},[p]:{}},i=chrome.runtime.getURL("icons/M_gray128.png"),O=chrome.runtime.getURL("icons/M_red128.png"),E=chrome.runtime.getURL("icons/M_green128.png"),R=t=>{const e=t[0].result[0],o=t[0].result[1]?e?O:E:i;chrome.action.setIcon({path:o})},a={tabId:-1,onlyTab:!1,isOpen:!1,alerts:!1,count:0},L=()=>{chrome.tabs.query({url:d},t=>{const e=l(t,b,"Google Meets");a.isOpen=e.isOpen,a.tabId=e.tabId,a.count=e.count,a.alerts=e.alerts,a.onlyTab=e.onlyTab})},n={tabId:-1,onlyTab:!1,isOpen:!1,alerts:!1,count:0},r={tabId:-1,onlyTab:!1,isOpen:!1,alerts:!1,count:0},U=()=>{chrome.tabs.query({url:T},t=>{const e=l(t,h,"Microsoft Teams");n.isOpen=e.isOpen,n.tabId=e.tabId,n.count=e.count,n.alerts=e.alerts,n.onlyTab=e.onlyTab}),chrome.tabs.query({url:g},t=>{const e=l(t,p,"Microsoft Teams");r.isOpen=e.isOpen,r.tabId=e.tabId,r.count=e.count,r.alerts=e.alerts,r.onlyTab=e.onlyTab})},M=(t,e,s)=>{chrome.tabs.query({url:e},o=>{t!=-1&&chrome.scripting.executeScript({target:{tabId:Number(o[t].id)},files:[s]})})},x=t=>M(t,d,"dist/sendKeypressMeet.js"),N=(t,e)=>M(t,e,"dist/sendKeypressTeams.js"),_=(t,e,s,o)=>{chrome.tabs.query({url:t},c=>{e==1&&chrome.scripting.executeScript({target:{tabId:Number(c[s].id)},func:o},R)})},S=(t,e,s)=>_(t,e,s,v),j=(t,e,s)=>_(t,e,s,B),v=()=>{var s;let t=!1,e=!0;for(let o of document.getElementsByTagName("*"))if(o.innerHTML.indexOf("Join now")!=-1||o.innerHTML.indexOf("Rejoin")!=-1)e=!1;else if(o.matches('[aria-label~="microphone"]')&&["DIV","BUTTON"].includes(o.nodeName)){const c=(s=o.dataset)==null?void 0:s.isMuted;if(c===void 0)continue;t=JSON.parse(c)}return[t,e]},B=()=>{var c;let t=!1,e=!0;const s=document.getElementsByTagName("iframe")[0].contentWindow;return t=((c=s==null?void 0:s.document)==null?void 0:c.getElementById("microphone-button")).dataset.state=="mic-off",[t,e]},l=(t,e,s="Meeting Service")=>{const o={isOpen:!1,tabId:-1,count:0,alerts:!1,onlyTab:!1};return t.forEach((c,m)=>{if(c.url==e){o.isOpen=!0;return}if(Object.keys(f[e]).length===0){o.tabId=m,o.count++;return}for(const[I,y]of Object.entries(f[e]))if(c.url===void 0||new URL(c.url)[I]!==y)return;o.tabId=m,o.count++}),o.count>0&&chrome.alarms.create("1min",{periodInMinutes:.05}),o.count===0&&(chrome.alarms.clear("1min"),chrome.action.setIcon({path:i}),chrome.action.setBadgeText({text:""})),o.count===1&&(o.alerts=!1,chrome.action.setBadgeText({text:""})),t.forEach((c,m)=>{o.alerts||o.count>1&&(chrome.notifications.create("",{type:"basic",title:"",message:`You have ${o.count} ${s} open. Close all but one.`,iconUrl:i}),o.alerts=!0,chrome.action.setBadgeText({text:"Err"}))}),o},u=t=>{if(L(),U(),!(a.count+n.count+r.count<=0)){if(a.count>0&&n.count+r.count<=0){t&&x(a.tabId),setTimeout(()=>S(d,a.count,a.tabId),50);return}if(a.count<=0&&n.count+r.count>0&&(n.count<=0||r.count<=0)){const e=n.count>0?n:r,s=n.count>0?T:g;t&&N(e.tabId,s),setTimeout(()=>j(s,e.count,e.tabId),50);return}chrome.notifications.create("",{type:"basic",title:"",message:`You have ${a.count+n.count+r.count} Meet & Teams open. Close all but one.`,iconUrl:i})}};chrome.action.onClicked.addListener(t=>{u(!0)});chrome.tabs.onUpdated.addListener((t,e,s)=>{(e.status=="complete"||e.discarded)&&u(!1)});chrome.alarms.onAlarm.addListener(t=>{t.name==="1min"&&u(!1)});u(!1);addEventListener("beforeunload",()=>{chrome.action.setIcon({path:i}),chrome.action.setBadgeText({text:""})});chrome.commands.onCommand.addListener(t=>{t==="toggle-mute"&&u(!0)});
