const b="https://meet.google.com/",m="https://meet.google.com/*",p="https://teams.microsoft.com/v2/",u="https://teams.microsoft.com/v2/*",r=chrome.runtime.getURL("icons/M_gray128.png"),T=chrome.runtime.getURL("icons/M_red128.png"),g=chrome.runtime.getURL("icons/M_green128.png"),M=e=>{const t=e[0].result[0],s=e[0].result[1]?t?T:g:r;chrome.action.setIcon({path:s})},n={tabId:-1,onlyTab:!1,isOpen:!1,alerts:!1,count:0},I=()=>{chrome.tabs.query({url:m},e=>{const t=h(e,b,"Google Meets");n.isOpen=t.isOpen,n.tabId=t.tabId,n.count=t.count,n.alerts=t.alerts,n.onlyTab=t.onlyTab})},a={tabId:-1,onlyTab:!1,isOpen:!1,alerts:!1,count:0},_=()=>{chrome.tabs.query({url:u},e=>{const t=h(e,p,"Microsoft Teams");a.isOpen=t.isOpen,a.tabId=t.tabId,a.count=t.count,a.alerts=t.alerts,a.onlyTab=t.onlyTab})},d=(e,t,o)=>{chrome.tabs.query({url:t},s=>{e!=-1&&chrome.scripting.executeScript({target:{tabId:Number(s[e].id)},files:[o]})})},y=e=>d(e,m,"dist/sendKeypressMeet.js"),E=e=>d(e,u,"dist/sendKeypressTeams.js"),f=(e,t,o,s)=>{chrome.tabs.query({url:e},c=>{t==1&&chrome.scripting.executeScript({target:{tabId:Number(c[o].id)},func:s},M)})},O=(e,t,o)=>f(e,t,o,x),L=(e,t,o)=>f(e,t,o,R),x=()=>{var o;let e=!1,t=!0;for(let s of document.getElementsByTagName("*"))if(s.innerHTML.indexOf("Join now")!=-1||s.innerHTML.indexOf("Rejoin")!=-1)t=!1;else if(s.matches('[aria-label~="microphone"]')&&["DIV","BUTTON"].includes(s.nodeName)){const c=(o=s.dataset)==null?void 0:o.isMuted;if(c===void 0)continue;e=JSON.parse(c)}return[e,t]},R=()=>{let e=!1,t=!0;return e=document.getElementById("microphone-button").dataset.trackModuleNameNew=="unMute",[e,t]},h=(e,t,o="Meeting Service")=>{const s={isOpen:!1,tabId:-1,count:0,alerts:!1,onlyTab:!1};return e.forEach((c,l)=>{c.url==t?s.isOpen=!0:s.count++}),s.count>0&&chrome.alarms.create("1min",{periodInMinutes:.05}),s.count===0&&(chrome.alarms.clear("1min"),chrome.action.setIcon({path:r}),chrome.action.setBadgeText({text:""})),s.count===1&&(s.alerts=!1,chrome.action.setBadgeText({text:""})),e.forEach((c,l)=>{s.alerts||(s.count>1?(chrome.notifications.create("",{type:"basic",title:"",message:`You have ${s.count} ${o} open. Close all but one.`,iconUrl:r}),s.alerts=!0,chrome.action.setBadgeText({text:"Err"})):s.tabId=l)}),s},i=e=>{if(I(),_(),!(n.count+a.count<=0)){if(n.count>0&&a.count<=0){e&&y(n.tabId),setTimeout(()=>O(m,n.count,n.tabId),50);return}if(n.count<=0&&a.count>0){e&&E(a.tabId),setTimeout(()=>L(u,a.count,a.tabId),50);return}chrome.notifications.create("",{type:"basic",title:"",message:`You have ${n.count+a.count} Meet & Teams open. Close all but one.`,iconUrl:r})}};chrome.action.onClicked.addListener(e=>{i(!0)});chrome.tabs.onUpdated.addListener((e,t,o)=>{(t.status=="complete"||t.discarded)&&i(!1)});chrome.alarms.onAlarm.addListener(e=>{e.name==="1min"&&i(!1)});i(!1);addEventListener("beforeunload",()=>{chrome.action.setIcon({path:r}),chrome.action.setBadgeText({text:""})});chrome.commands.onCommand.addListener(e=>{e==="toggle-mute"&&i(!0)});
