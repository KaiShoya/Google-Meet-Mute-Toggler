const b="https://meet.google.com/",l="https://meet.google.com/*",h="https://teams.microsoft.com/_",T="https://teams.microsoft.com/_*",p="https://teams.microsoft.com/v2/",g="https://teams.microsoft.com/v2/*",I={[b]:"",[h]:"#/modern-calling/",[p]:""},i=chrome.runtime.getURL("icons/M_gray128.png"),y=chrome.runtime.getURL("icons/M_red128.png"),E=chrome.runtime.getURL("icons/M_green128.png"),O=t=>{const e=t[0].result[0],s=t[0].result[1]?e?y:E:i;chrome.action.setIcon({path:s})},c={tabId:-1,onlyTab:!1,isOpen:!1,alerts:!1,count:0},R=()=>{chrome.tabs.query({url:l},t=>{const e=u(t,b,"Google Meets");c.isOpen=e.isOpen,c.tabId=e.tabId,c.count=e.count,c.alerts=e.alerts,c.onlyTab=e.onlyTab})},n={tabId:-1,onlyTab:!1,isOpen:!1,alerts:!1,count:0},r={tabId:-1,onlyTab:!1,isOpen:!1,alerts:!1,count:0},L=()=>{chrome.tabs.query({url:T},t=>{const e=u(t,h,"Microsoft Teams");n.isOpen=e.isOpen,n.tabId=e.tabId,n.count=e.count,n.alerts=e.alerts,n.onlyTab=e.onlyTab}),chrome.tabs.query({url:g},t=>{const e=u(t,p,"Microsoft Teams");r.isOpen=e.isOpen,r.tabId=e.tabId,r.count=e.count,r.alerts=e.alerts,r.onlyTab=e.onlyTab})},M=(t,e,o)=>{chrome.tabs.query({url:e},s=>{t!=-1&&chrome.scripting.executeScript({target:{tabId:Number(s[t].id)},files:[o]})})},x=t=>M(t,l,"dist/sendKeypressMeet.js"),S=(t,e)=>M(t,e,"dist/sendKeypressTeams.js"),_=(t,e,o,s)=>{chrome.tabs.query({url:t},a=>{e==1&&chrome.scripting.executeScript({target:{tabId:Number(a[o].id)},func:s},O)})},U=(t,e,o)=>_(t,e,o,A),N=(t,e,o)=>_(t,e,o,B),A=()=>{var o;let t=!1,e=!0;for(let s of document.getElementsByTagName("*"))if(s.innerHTML.indexOf("Join now")!=-1||s.innerHTML.indexOf("Rejoin")!=-1)e=!1;else if(s.matches('[aria-label~="microphone"]')&&["DIV","BUTTON"].includes(s.nodeName)){const a=(o=s.dataset)==null?void 0:o.isMuted;if(a===void 0)continue;t=JSON.parse(a)}return[t,e]},B=()=>{var a;let t=!1,e=!0;const o=document.getElementsByTagName("iframe")[0].contentWindow;return t=((a=o==null?void 0:o.document)==null?void 0:a.getElementById("microphone-button")).dataset.state=="mic-off",[t,e]},u=(t,e,o="Meeting Service")=>{const s={isOpen:!1,tabId:-1,count:0,alerts:!1,onlyTab:!1};return t.forEach((a,d)=>{var f;a.url==e?s.isOpen=!0:(f=a.url)!=null&&f.startsWith(e+I[e])&&s.count++}),s.count>0&&chrome.alarms.create("1min",{periodInMinutes:.05}),s.count===0&&(chrome.alarms.clear("1min"),chrome.action.setIcon({path:i}),chrome.action.setBadgeText({text:""})),s.count===1&&(s.alerts=!1,chrome.action.setBadgeText({text:""})),t.forEach((a,d)=>{s.alerts||(s.count>1?(chrome.notifications.create("",{type:"basic",title:"",message:`You have ${s.count} ${o} open. Close all but one.`,iconUrl:i}),s.alerts=!0,chrome.action.setBadgeText({text:"Err"})):s.tabId=d)}),s},m=t=>{if(R(),L(),!(c.count+n.count+r.count<=0)){if(c.count>0&&n.count+r.count<=0){t&&x(c.tabId),setTimeout(()=>U(l,c.count,c.tabId),50);return}if(c.count<=0&&n.count+r.count>0&&(n.count<=0||r.count<=0)){const e=n.count>0?n:r,o=n.count>0?T:g;t&&S(e.tabId,o),setTimeout(()=>N(o,e.count,e.tabId),50);return}chrome.notifications.create("",{type:"basic",title:"",message:`You have ${c.count+n.count+r.count} Meet & Teams open. Close all but one.`,iconUrl:i})}};chrome.action.onClicked.addListener(t=>{m(!0)});chrome.tabs.onUpdated.addListener((t,e,o)=>{(e.status=="complete"||e.discarded)&&m(!1)});chrome.alarms.onAlarm.addListener(t=>{t.name==="1min"&&m(!1)});m(!1);addEventListener("beforeunload",()=>{chrome.action.setIcon({path:i}),chrome.action.setBadgeText({text:""})});chrome.commands.onCommand.addListener(t=>{t==="toggle-mute"&&m(!0)});
